<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{fragments/layout :: head}"></head>

<body>
    <div class="d-flex" id="wrapper">
        <!-- Sidebar -->
        <div th:replace="~{fragments/layout :: sidebar}"></div>

        <!-- Page Content -->
        <div id="page-content-wrapper">
            <div th:replace="~{fragments/layout :: navbar}"></div>

            <div class="container-fluid px-4 py-4">
                <div th:if="${message}" class="alert alert-success text-center" role="alert" th:text="${message}"></div>
                <div th:if="${error}" class="alert alert-danger text-center" role="alert" th:text="${error}"></div>
                
                <div class="bg-primary text-white rounded-3 p-4 mb-4">
                    <div class="d-flex flex-column flex-md-row align-items-start align-items-md-center justify-content-between gap-3">
                        <div>
                            <h2 class="mb-1">Enroll Student to Courses</h2>
                        </div>
                        <a th:href="@{/students/list}" class="btn btn-light text-primary fw-semibold"><i class="bi bi-arrow-left me-1"></i> Back to Students</a>
                    </div>
                </div>

                <form th:action="@{/enrollment/enroll}" method="post" id="enrollmentForm">
                    <div class="row g-4">
                    <!-- Left: Course selection -->
                    <div class="col-lg-8">
                        <div class="card h-100">
                            <div class="card-header bg-white d-flex justify-content-between align-items-center">
                                <span><i class="bi bi-list-check me-1"></i> Course Selection</span>
                                <span class="text-muted small">Multi-select allowed</span>
                            </div>
                            <div class="card-body">
                                <div th:if="${courses == null || courses.isEmpty()}" class="text-center text-muted py-4">
                                    No active courses available
                                </div>
                                <div class="table-responsive" th:if="${courses != null && !courses.isEmpty()}">
                                    <table class="table table-hover align-middle">
                                        <thead>
                                            <tr>
                                                <th style="width: 60px;">Select</th>
                                                <th>Course Name</th>
                                                <th class="text-end">Fee</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr th:each="course : ${courses}">
                                                <td data-label="Select">
                                                    <div class="form-check">
                                                        <input class="form-check-input course-checkbox" type="checkbox" 
                                                               name="courseIds" th:value="${course.id}"
                                                               th:data-fee="${course.fee}" 
                                                               th:data-name="${course.courseName}">
                                                    </div>
                                                </td>
                                                <td data-label="Course Name" th:text="${course.courseName}">Course Name</td>
                                                <td data-label="Fee" class="text-end" th:text="'$' + ${#numbers.formatDecimal(course.fee, 1, 2)}">$0.00</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- Right: Student details and total -->
                    <div class="col-lg-4">
                        <div class="card h-100">
                            <div class="card-header bg-white">
                                <i class="bi bi-person-check me-1"></i> Student & Summary
                            </div>
                            <div class="card-body d-flex flex-column gap-3">
                                <div>
                                    <label for="studentSelect" class="form-label">Select Student</label>
                                    <select id="studentSelect" name="studentId" class="form-select mb-2" required>
                                        <option value="" selected>Select a student</option>
                                        <option th:each="student : ${students}" th:value="${student.id}" 
                                                th:text="${student.firstName + ' ' + student.lastName + ' (' + student.email + ')'}">
                                            Student Name (email)
                                        </option>
                                    </select>
                                    <div class="p-3 bg-light border rounded" id="studentInfo" style="display:none;">
                                        <div class="text-muted small">Selected Student</div>
                                        <div class="fw-semibold mb-0" id="studentName">-</div>
                                        <div class="small text-muted" id="studentEmail">-</div>
                                    </div>
                                </div>
                                <div class="p-3 bg-light border rounded">
                                    <div class="d-flex justify-content-between mb-1">
                                        <span class="text-muted">Courses Selected</span>
                                        <strong id="coursesCount">0</strong>
                                    </div>
                                    <div class="d-flex justify-content-between">
                                        <span class="text-muted">Total Fee</span>
                                        <strong class="text-primary" id="totalFee">$0.00</strong>
                                    </div>
                                </div>
                                <div>
                                    <div class="text-muted small mb-1">Selected Courses</div>
                                    <ul class="mb-3" id="selectedCoursesList">
                                        <li class="text-muted">No courses selected</li>
                                    </ul>
                                    <div class="d-flex flex-wrap gap-2">
                                        <a th:href="@{/enrollment/list}" class="btn btn-outline-secondary flex-grow-1">
                                            <i class="bi bi-arrow-left me-1"></i> Cancel
                                        </a>
                                        <button type="submit" class="btn btn-primary flex-grow-1">
                                            <i class="bi bi-check2-circle me-1"></i> Enroll
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                </form>
            </div>
        </div>
    </div>

    <div th:replace="~{fragments/layout :: scripts}"></div>
    <script>
        // Update summary when courses are selected/deselected
        document.querySelectorAll('.course-checkbox').forEach(checkbox => {
            checkbox.addEventListener('change', updateSummary);
        });

        // Update student info when student is selected
        document.getElementById('studentSelect').addEventListener('change', function() {
            const selectedOption = this.options[this.selectedIndex];
            const studentInfo = document.getElementById('studentInfo');
            
            if (this.value) {
                const fullText = selectedOption.text;
                const emailMatch = fullText.match(/\((.+)\)/);
                const name = fullText.split('(')[0].trim();
                const email = emailMatch ? emailMatch[1] : '';
                
                document.getElementById('studentName').textContent = name;
                document.getElementById('studentEmail').textContent = email;
                studentInfo.style.display = 'block';
            } else {
                studentInfo.style.display = 'none';
            }
        });

        function updateSummary() {
            const checkboxes = document.querySelectorAll('.course-checkbox:checked');
            const count = checkboxes.length;
            let totalFee = 0;
            const coursesList = document.getElementById('selectedCoursesList');
            
            coursesList.innerHTML = '';
            
            if (count === 0) {
                coursesList.innerHTML = '<li class="text-muted">No courses selected</li>';
            } else {
                checkboxes.forEach(cb => {
                    const fee = parseFloat(cb.dataset.fee);
                    const name = cb.dataset.name;
                    totalFee += fee;
                    
                    const li = document.createElement('li');
                    li.textContent = `${name} - $${fee.toFixed(2)}`;
                    coursesList.appendChild(li);
                });
            }
            
            document.getElementById('coursesCount').textContent = count;
            document.getElementById('totalFee').textContent = '$' + totalFee.toFixed(2);
        }

        // Prevent form submission if no student or courses selected
        document.getElementById('enrollmentForm').addEventListener('submit', function(e) {
            const studentId = document.getElementById('studentSelect').value;
            const selectedCourses = document.querySelectorAll('.course-checkbox:checked').length;
            
            if (!studentId) {
                e.preventDefault();
                alert('Please select a student');
                return false;
            }
            
            if (selectedCourses === 0) {
                e.preventDefault();
                alert('Please select at least one course');
                return false;
            }
        });
    </script>
</body>

</html>
